<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitPath - AI Workout Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            background-color: #0f172a; /* slate-900 */
            background-image: linear-gradient(rgba(15, 23, 42, 0.97), rgba(15, 23, 42, 0.97)), url('https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?q=80&w=2070&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Custom radio/checkbox styles */
        .custom-option input[type="radio"],
        .custom-option input[type="checkbox"] {
            display: none;
        }
        .custom-option label {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border-color: #334155; /* slate-700 */
            background-color: #1e293b; /* slate-800 */
        }
        .custom-option label:hover {
            border-color: #4f46e5; /* indigo-600 */
            transform: translateY(-2px);
        }
        .custom-option input:checked + label {
            background-color: #4f46e5; /* indigo-600 */
            color: #ffffff;
            border-color: #4f46e5;
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 4px 20px 0 rgba(79, 70, 229, 0.3);
        }
        .custom-option label .icon {
            transition: transform 0.3s;
        }
        .custom-option input:checked + label .icon {
            transform: scale(1.1);
            color: #ffffff;
        }

        /* Animations */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .stagger-in {
             animation: fadeIn 0.5s ease-in-out both;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-200">

    <div id="app" class="max-w-2xl mx-auto p-4 md:p-6">

        <!-- Header -->
        <header class="text-center mb-8 flex flex-col items-center">
             <svg class="w-12 h-12 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
            <h1 class="text-4xl sm:text-5xl font-bold text-white mt-2">FitPath <span class="text-indigo-500">AI</span></h1>
            <p class="text-slate-400 mt-2 text-lg">Your intelligent pocket personal trainer. 🏋️‍♂️</p>
        </header>

        <!-- Selection Screen -->
        <main id="selectionScreen" class="space-y-8">
            <!-- Step 1: Primary Goal -->
            <section>
                <h2 class="text-xl font-semibold mb-4 text-white flex items-center"><span class="bg-indigo-600 text-white rounded-full w-8 h-8 text-sm inline-flex items-center justify-center mr-3">1</span> 🎯 Primary Goal</h2>
                <div id="goal" class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                    <div class="custom-option"><input type="radio" id="goal_muscle" name="goal" value="Build Muscle" checked><label for="goal_muscle" class="flex flex-col items-center justify-center text-center border-2 rounded-lg p-4 font-medium h-full"><svg class="w-8 h-8 mb-2 icon text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20.57 14.86L22 13.43 20.57 12 17 15.57 8.43 7 12 3.43 10.57 2 9.14 3.43 7.71 2 5.57 4.14 4.14 2.71 2.71 4.14l1.43 1.43L2 7.71l1.43 1.43L2 10.57 3.43 12 7 8.43 15.57 17 12 20.57 13.43 22l1.43-1.43L16.29 22l2.14-2.14 1.43 1.43 1.43-1.43-1.43-1.43L22 16.29z"/></svg>Build Muscle 💪</label></div>
                    <div class="custom-option"><input type="radio" id="goal_weight" name="goal" value="Lose Weight"><label for="goal_weight" class="flex flex-col items-center justify-center text-center border-2 rounded-lg p-4 font-medium h-full"><svg class="w-8 h-8 mb-2 icon text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path></svg>Lose Weight 🔥</label></div>
                    <div class="custom-option"><input type="radio" id="goal_strength" name="goal" value="Get Stronger"><label for="goal_strength" class="flex flex-col items-center justify-center text-center border-2 rounded-lg p-4 font-medium h-full"><svg class="w-8 h-8 mb-2 icon text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 11l3-3m0 0l3 3m-3-3v8m0-13a9 9 0 110 18 9 9 0 010-18z"></path></svg>Get Stronger 🏋️</label></div>
                    <div class="custom-option"><input type="radio" id="goal_endurance" name="goal" value="Improve Endurance"><label for="goal_endurance" class="flex flex-col items-center justify-center text-center border-2 rounded-lg p-4 font-medium h-full"><svg class="w-8 h-8 mb-2 icon text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>Endurance 🏃</label></div>
                    <div class="custom-option"><input type="radio" id="goal_flexibility" name="goal" value="Increase Flexibility"><label for="goal_flexibility" class="flex flex-col items-center justify-center text-center border-2 rounded-lg p-4 font-medium h-full"><svg class="w-8 h-8 mb-2 icon text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>Flexibility 🧘</label></div>
                    <div class="custom-option"><input type="radio" id="goal_general" name="goal" value="General Fitness"><label for="goal_general" class="flex flex-col items-center justify-center text-center border-2 rounded-lg p-4 font-medium h-full"><svg class="w-8 h-8 mb-2 icon text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>General ❤️</label></div>
                </div>
            </section>

            <!-- Step 2: Available Equipment -->
            <section>
                <h2 class="text-xl font-semibold mb-4 text-white flex items-center"><span class="bg-indigo-600 text-white rounded-full w-8 h-8 text-sm inline-flex items-center justify-center mr-3">2</span> 🛠️ Equipment</h2>
                <div id="equipment" class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                    <div class="custom-option"><input type="checkbox" id="equip_gym" name="equipment" value="Full Gym"><label for="equip_gym" class="flex flex-col items-center justify-center text-center border-2 rounded-lg p-4 font-medium h-full"><svg class="w-8 h-8 mb-2 icon text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21 5H3c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm-2 12H5V7h14v10z"/></svg>Full Gym 🏋️‍♀️</label></div>
                    <div class="custom-option"><input type="checkbox" id="equip_home" name="equipment" value="Home Gym"><label for="equip_home" class="flex flex-col items-center justify-center text-center border-2 rounded-lg p-4 font-medium h-full"><svg class="w-8 h-8 mb-2 icon text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>Home Gym 🏠</label></div>
                    <div class="custom-option"><input type="checkbox" id="equip_dumbbells" name="equipment" value="Dumbbells"><label for="equip_dumbbells" class="flex flex-col items-center justify-center text-center border-2 rounded-lg p-4 font-medium h-full"><svg class="w-8 h-8 mb-2 icon text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21 8H3V6h18v2zm0 4H3v2h18v-2zm0 6H3v2h18v-2z"/></svg>Dumbbells</label></div>
                    <div class="custom-option"><input type="checkbox" id="equip_bands" name="equipment" value="Bands"><label for="equip_bands" class="flex flex-col items-center justify-center text-center border-2 rounded-lg p-4 font-medium h-full"><svg class="w-8 h-8 mb-2 icon text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899l4-4a4 4 0 000-5.656l-1.1 1.1"></path></svg>Bands</label></div>
                    <div class="custom-option"><input type="checkbox" id="equip_bodyweight" name="equipment" value="Bodyweight" checked><label for="equip_bodyweight" class="flex flex-col items-center justify-center text-center border-2 rounded-lg p-4 font-medium h-full"><svg class="w-8 h-8 mb-2 icon text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>Bodyweight 🤸</label></div>
                    <div class="custom-option"><input type="checkbox" id="equip_none" name="equipment" value="None"><label for="equip_none" class="flex flex-col items-center justify-center text-center border-2 rounded-lg p-4 font-medium h-full"><svg class="w-8 h-8 mb-2 icon text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path></svg>None</label></div>
                </div>
            </section>

            <!-- Step 3: Target Muscle Group -->
            <section>
                <h2 class="text-xl font-semibold mb-4 text-white flex items-center"><span class="bg-indigo-600 text-white rounded-full w-8 h-8 text-sm inline-flex items-center justify-center mr-3">3</span> 💪 Muscle Groups <span class="text-slate-400 font-normal text-sm ml-2">(Optional)</span></h2>
                <div id="muscles" class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                     <div class="custom-option"><input type="checkbox" id="muscle_full" name="muscles" value="Full Body" checked><label for="muscle_full" class="flex flex-col items-center justify-center text-center border-2 rounded-lg p-4 font-medium h-full"><svg class="w-8 h-8 mb-2 icon text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21v-1.5a6 6 0 00-6-6M3 21v-1.5a6 6 0 016-6"></path></svg>Full Body 🌐</label></div>
                     <div class="custom-option"><input type="checkbox" id="muscle_upper" name="muscles" value="Upper Body"><label for="muscle_upper" class="flex flex-col items-center justify-center text-center border-2 rounded-lg p-4 font-medium h-full"><svg class="w-8 h-8 mb-2 icon text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.5 16.5v-2.5a3.5 3.5 0 017 0v2.5m-3.5 0V19m0-2.5h-1m2 0h1M18.5 16.5v-2.5a3.5 3.5 0 00-7 0v2.5m3.5 0V19m0-2.5h1m-2 0h-1m0 0a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"></path></svg>Upper Body 💪</label></div>
                     <div class="custom-option"><input type="checkbox" id="muscle_lower" name="muscles" value="Lower Body"><label for="muscle_lower" class="flex flex-col items-center justify-center text-center border-2 rounded-lg p-4 font-medium h-full"><svg class="w-8 h-8 mb-2 icon text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>Lower Body 🦵</label></div>
                     <div class="custom-option"><input type="checkbox" id="muscle_core" name="muscles" value="Core"><label for="muscle_core" class="flex flex-col items-center justify-center text-center border-2 rounded-lg p-4 font-medium h-full"><svg class="w-8 h-8 mb-2 icon text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8"></path></svg>Core 🧘</label></div>
                     <div class="custom-option"><input type="checkbox" id="muscle_push" name="muscles" value="Push"><label for="muscle_push" class="flex flex-col items-center justify-center text-center border-2 rounded-lg p-4 font-medium h-full"><svg class="w-8 h-8 mb-2 icon text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path></svg>Push 👉</label></div>
                     <div class="custom-option"><input type="checkbox" id="muscle_pull" name="muscles" value="Pull"><label for="muscle_pull" class="flex flex-col items-center justify-center text-center border-2 rounded-lg p-4 font-medium h-full"><svg class="w-8 h-8 mb-2 icon text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 17l-5-5m0 0l5-5m-5 5h12"></path></svg>Pull 👈</label></div>
                </div>
            </section>
            
             <!-- Step 4: Workout Duration -->
            <section>
                <h2 class="text-xl font-semibold mb-4 text-white flex items-center"><span class="bg-indigo-600 text-white rounded-full w-8 h-8 text-sm inline-flex items-center justify-center mr-3">4</span> ⏱️ Duration</h2>
                <div id="duration" class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                    <div class="custom-option"><input type="radio" id="duration_quick" name="duration" value="15"><label for="duration_quick" class="block w-full text-center border-2 rounded-lg p-4 font-medium">&lt; 15 min</label></div>
                    <div class="custom-option"><input type="radio" id="duration_standard" name="duration" value="30" checked><label for="duration_standard" class="block w-full text-center border-2 rounded-lg p-4 font-medium">15-30 min</label></div>
                    <div class="custom-option"><input type="radio" id="duration_full" name="duration" value="60"><label for="duration_full" class="block w-full text-center border-2 rounded-lg p-4 font-medium">30-60 min</label></div>
                    <div class="custom-option"><input type="radio" id="duration_marathon" name="duration" value="61"><label for="duration_marathon" class="block w-full text-center border-2 rounded-lg p-4 font-medium">60+ min</label></div>
                </div>
            </section>

            <!-- Step 5 & 6 -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <section>
                    <h2 class="text-xl font-semibold mb-4 text-white flex items-center"><span class="bg-indigo-600 text-white rounded-full w-8 h-8 text-sm inline-flex items-center justify-center mr-3">5</span> 🌟 Experience</h2>
                    <div id="experience" class="grid grid-cols-3 gap-4">
                        <div class="custom-option"><input type="radio" id="level_beginner" name="experience" value="Beginner" checked><label for="level_beginner" class="block w-full text-center border-2 rounded-lg p-4 font-medium">Beginner</label></div>
                        <div class="custom-option"><input type="radio" id="level_intermediate" name="experience" value="Intermediate"><label for="level_intermediate" class="block w-full text-center border-2 rounded-lg p-4 font-medium">Mid</label></div>
                        <div class="custom-option"><input type="radio" id="level_advanced" name="experience" value="Advanced"><label for="level_advanced" class="block w-full text-center border-2 rounded-lg p-4 font-medium">Advanced</label></div>
                    </div>
                </section>
                 <section>
                    <h2 class="text-xl font-semibold mb-4 text-white flex items-center"><span class="bg-indigo-600 text-white rounded-full w-8 h-8 text-sm inline-flex items-center justify-center mr-3">6</span> 😊 Mood <span class="text-slate-400 font-normal text-sm ml-2">(Optional)</span></h2>
                    <div id="intensity" class="grid grid-cols-3 gap-4">
                        <div class="custom-option"><input type="radio" id="intensity_light" name="intensity" value="Light"><label for="intensity_light" class="block w-full text-center border-2 rounded-lg p-4 font-medium">Easy</label></div>
                        <div class="custom-option"><input type="radio" id="intensity_moderate" name="intensity" value="Moderate" checked><label for="intensity_moderate" class="block w-full text-center border-2 rounded-lg p-4 font-medium">Steady</label></div>
                        <div class="custom-option"><input type="radio" id="intensity_high" name="intensity" value="High"><label for="intensity_high" class="block w-full text-center border-2 rounded-lg p-4 font-medium">Intense</label></div>
                    </div>
                </section>
            </div>

            <!-- Generate Button -->
            <div class="pt-6">
                 <button id="generateBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-4 rounded-lg text-lg transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50 flex items-center justify-center shadow-lg shadow-indigo-500/20">
                    ✨ Generate My AI Workout
                </button>
            </div>
        </main>

        <!-- Workout Screen -->
        <section id="workoutScreen" class="hidden fade-in">
            <div class="flex items-center justify-between mb-6">
                <button id="backBtn" class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    🔄 New Workout
                </button>
                 <button id="startBtn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 flex items-center shadow-lg shadow-emerald-500/20">
                    ▶️ Start Workout
                    <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </button>
            </div>
            
            <div class="bg-slate-800/80 backdrop-blur-sm p-5 rounded-lg mb-6 border border-slate-700">
                <h2 id="workoutTitle" class="text-2xl font-bold text-white">Your Workout is Ready</h2>
                <p id="workoutSubtitle" class="text-slate-400 mt-1">Here's what we've generated for you.</p>
                 <div id="workoutTimer" class="mt-4 text-center hidden">
                    <p class="text-lg font-semibold text-slate-300">Rest Timer</p>
                    <p id="timerDisplay" class="text-6xl font-bold text-indigo-400">00:00</p>
                </div>
                 <div id="aiSummary" class="bg-slate-700/50 p-4 rounded-lg mt-4 border-l-4 border-indigo-500 hidden">
                    <p class="text-slate-300"></p>
                </div>
            </div>

            <div id="workoutList" class="space-y-4">
                <!-- Exercises will be injected here -->
            </div>
             <div id="finisherContainer" class="mt-6">
                <button id="finisherBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg text-md transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-purple-500 focus:ring-opacity-50 flex items-center justify-center shadow-lg shadow-purple-500/20">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7.014A8.003 8.003 0 0122 12c0 3-1 7-7 7a6.657 6.657 0 01-2.343-.343z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 12l9 9"></path></svg>
                    Suggest a Finisher
                </button>
            </div>
        </section>
        
        <!-- Loading Spinner -->
        <div id="loading" class="hidden fixed inset-0 bg-slate-900 bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm">
            <div class="text-center">
                <div class="w-16 h-16 border-4 border-dashed rounded-full animate-spin border-indigo-500 mx-auto"></div>
                <p id="loadingText" class="text-white text-lg mt-4">Crafting your perfect workout...</p>
            </div>
        </div>

    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Elements ---
        const selectionScreen = document.getElementById('selectionScreen');
        const workoutScreen = document.getElementById('workoutScreen');
        const generateBtn = document.getElementById('generateBtn');
        const backBtn = document.getElementById('backBtn');
        const startBtn = document.getElementById('startBtn');
        const loadingSpinner = document.getElementById('loading');
        const loadingText = document.getElementById('loadingText');
        const workoutList = document.getElementById('workoutList');
        const workoutTitle = document.getElementById('workoutTitle');
        const workoutSubtitle = document.getElementById('workoutSubtitle');
        const workoutTimer = document.getElementById('workoutTimer');
        const timerDisplay = document.getElementById('timerDisplay');
        const aiSummary = document.getElementById('aiSummary');
        const finisherContainer = document.getElementById('finisherContainer');
        
        let timerInterval;
        let restTime = 60; // default rest time
        
        // --- Gemini API Configuration ---
        const apiKey = ""; // This will be handled by the environment
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        // --- Icon Database ---
        const iconMap = {
            'Chest': '<svg class="w-8 h-8 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>',
            'Back': '<svg class="w-8 h-8 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m12 0a2 2 0 100-4m0 4a2 2 0 110-4M6 12a2 2 0 100-4m0 4a2 2 0 110-4m12 0a2 2 0 100-4m0 4a2 2 0 110-4M6 20a2 2 0 100-4m0 4a2 2 0 110-4m12 0a2 2 0 100-4m0 4a2 2 0 110-4m-6-4a2 2 0 100-4m0 4a2 2 0 110-4m0 8a2 2 0 100-4m0 4a2 2 0 110-4"></path></svg>',
            'Shoulders': '<svg class="w-8 h-8 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"></path></svg>',
            'Biceps': '<svg class="w-8 h-8 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
            'Triceps': '<svg class="w-8 h-8 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
            'Quads': '<svg class="w-8 h-8 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>',
            'Glutes': '<svg class="w-8 h-8 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>',
            'Hamstrings': '<svg class="w-8 h-8 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg>',
            'Core': '<svg class="w-8 h-8 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"></path></svg>',
            'Full Body': '<svg class="w-8 h-8 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
            'Warm-up': '<svg class="w-8 h-8 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>',
            'Cool-down': '<svg class="w-8 h-8 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
            '🔥 Finisher': '<svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7.014A8.003 8.003 0 0122 12c0 3-1 7-7 7a6.657 6.657 0 01-2.343-.343z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 12l9 9"></path></svg>',
        };

        // --- Exercise Database ---
        const exerciseDB = [
            { name: "Push-up", primary_muscle: "Chest", equipment: ["Bodyweight"], difficulty: "Beginner", type: "Push" },
            { name: "Squat", primary_muscle: "Quads", equipment: ["Bodyweight"], difficulty: "Beginner", type: "Legs" },
            { name: "Jumping Jacks", primary_muscle: "Full Body", equipment: ["Bodyweight", "None"], difficulty: "Beginner", type: "Cardio" },
            { name: "Plank", primary_muscle: "Core", equipment: ["Bodyweight", "None"], difficulty: "Beginner", type: "Core" },
            { name: "Lunge", primary_muscle: "Quads", equipment: ["Bodyweight"], difficulty: "Beginner", type: "Legs" },
            { name: "Burpee", primary_muscle: "Full Body", equipment: ["Bodyweight"], difficulty: "Intermediate", type: "Cardio" },
            { name: "Pull-up", primary_muscle: "Back", equipment: ["Home Gym"], difficulty: "Intermediate", type: "Pull" },
            { name: "High Knees", primary_muscle: "Full Body", equipment: ["Bodyweight", "None"], difficulty: "Beginner", type: "Cardio" },
            { name: "Mountain Climbers", primary_muscle: "Core", equipment: ["Bodyweight", "None"], difficulty: "Intermediate", type: "Cardio" },
            { name: "Glute Bridge", primary_muscle: "Glutes", equipment: ["Bodyweight"], difficulty: "Beginner", type: "Legs" },
            { name: "Pike Push-up", primary_muscle: "Shoulders", equipment: ["Bodyweight"], difficulty: "Intermediate", type: "Push" },
            { name: "Superman", primary_muscle: "Back", equipment: ["Bodyweight", "None"], difficulty: "Beginner", type: "Pull" },
            { name: "Crunches", primary_muscle: "Core", equipment: ["Bodyweight", "None"], difficulty: "Beginner", type: "Core" },
            { name: "Dumbbell Bench Press", primary_muscle: "Chest", equipment: ["Dumbbells", "Home Gym"], difficulty: "Beginner", type: "Push" },
            { name: "Dumbbell Fly", primary_muscle: "Chest", equipment: ["Dumbbells", "Home Gym"], difficulty: "Intermediate", type: "Push" },
            { name: "Goblet Squat", primary_muscle: "Quads", equipment: ["Dumbbells", "Home Gym"], difficulty: "Beginner", type: "Legs" },
            { name: "Dumbbell Row", primary_muscle: "Back", equipment: ["Dumbbells", "Home Gym"], difficulty: "Beginner", type: "Pull" },
            { name: "Dumbbell Shoulder Press", primary_muscle: "Shoulders", equipment: ["Dumbbells", "Home Gym"], difficulty: "Beginner", type: "Push" },
            { name: "Bicep Curl", primary_muscle: "Biceps", equipment: ["Dumbbells", "Home Gym"], difficulty: "Beginner", type: "Pull" },
            { name: "Tricep Kickback", primary_muscle: "Triceps", equipment: ["Dumbbells", "Home Gym"], difficulty: "Beginner", type: "Push" },
            { name: "Romanian Deadlift", primary_muscle: "Hamstrings", equipment: ["Dumbbells", "Home Gym"], difficulty: "Intermediate", type: "Legs" },
            { name: "Banded Pull-Apart", primary_muscle: "Shoulders", equipment: ["Bands", "Home Gym"], difficulty: "Beginner", type: "Pull" },
            { name: "Banded Squat", primary_muscle: "Quads", equipment: ["Bands"], difficulty: "Beginner", type: "Legs" },
            { name: "Banded Chest Press", primary_muscle: "Chest", equipment: ["Bands", "Home Gym"], difficulty: "Beginner", type: "Push" },
            { name: "Banded Bicep Curl", primary_muscle: "Biceps", equipment: ["Bands", "Home Gym"], difficulty: "Beginner", type: "Pull" },
            { name: "Banded Tricep Pushdown", primary_muscle: "Triceps", equipment: ["Bands", "Home Gym"], difficulty: "Beginner", type: "Push" },
            { name: "Barbell Bench Press", primary_muscle: "Chest", equipment: ["Full Gym"], difficulty: "Intermediate", type: "Push" },
            { name: "Barbell Squat", primary_muscle: "Quads", equipment: ["Full Gym"], difficulty: "Intermediate", type: "Legs" },
            { name: "Deadlift", primary_muscle: "Full Body", equipment: ["Full Gym"], difficulty: "Advanced", type: "Legs" },
            { name: "Lat Pulldown", primary_muscle: "Back", equipment: ["Full Gym"], difficulty: "Beginner", type: "Pull" },
            { name: "Leg Press", primary_muscle: "Quads", equipment: ["Full Gym"], difficulty: "Beginner", type: "Legs" },
            { name: "Cable Crossover", primary_muscle: "Chest", equipment: ["Full Gym"], difficulty: "Intermediate", type: "Push" },
        ];
        
        // --- Muscle Group Definitions ---
        const muscleGroups = {
            "Upper Body": ["Chest", "Back", "Shoulders", "Biceps", "Triceps"],
            "Lower Body": ["Quads", "Glutes", "Hamstrings", "Calves"],
            "Core": ["Core"],
            "Push": ["Chest", "Shoulders", "Triceps"],
            "Pull": ["Back", "Biceps"],
            "Full Body": ["Chest", "Back", "Shoulders", "Biceps", "Triceps", "Quads", "Glutes", "Hamstrings", "Core", "Full Body"],
        };
        
        let currentSelections = {};

        // --- Event Listeners ---
        generateBtn.addEventListener('click', generateWorkout);
        backBtn.addEventListener('click', showSelectionScreen);
        startBtn.addEventListener('click', startWorkout);
        
        // --- Gemini API Call Function ---
        async function callGeminiAPI(prompt, isJson = true) {
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
            };
            if (isJson) {
                payload.generationConfig = {
                    responseMimeType: "application/json",
                }
            }

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!text) {
                    throw new Error("Invalid response structure from API.");
                }
                return text;
            } catch (error) {
                console.error("Gemini API call error:", error);
                return null;
            }
        }
        
        // --- Main Functions ---

        function getUserSelections() {
            const goal = document.querySelector('input[name="goal"]:checked').value;
            const equipment = Array.from(document.querySelectorAll('input[name="equipment"]:checked')).map(el => el.value);
            const muscles = Array.from(document.querySelectorAll('input[name="muscles"]:checked')).map(el => el.value);
            const duration = parseInt(document.querySelector('input[name="duration"]:checked').value);
            const experience = document.querySelector('input[name="experience"]:checked').value;
            const intensity = document.querySelector('input[name="intensity"]:checked')?.value || 'Moderate';
            return { goal, equipment, muscles, duration, experience, intensity };
        }

        async function generateWorkout() {
            loadingText.textContent = "Crafting your perfect workout...";
            loadingSpinner.classList.remove('hidden');
            selectionScreen.classList.add('hidden');
            aiSummary.classList.add('hidden');
            finisherContainer.innerHTML = `<button id="finisherBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg text-md transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-purple-500 focus:ring-opacity-50 flex items-center justify-center shadow-lg shadow-purple-500/20"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7.014A8.003 8.003 0 0122 12c0 3-1 7-7 7a6.657 6.657 0 01-2.343-.343z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 12l9 9"></path></svg>Suggest a Finisher</button>`;
            document.getElementById('finisherBtn').addEventListener('click', suggestFinisher);

            currentSelections = getUserSelections();
            const workout = buildWorkout(currentSelections);
            displayWorkout(workout, currentSelections, false);

            loadingText.textContent = "Personalizing with AI...";

            const exerciseNames = workout.filter(ex => !["Warm-up", "Cool-down"].includes(ex.primary_muscle)).map(ex => ex.name).join(', ');
            const prompt = `You are FitPath AI, a motivational and expert personal trainer. A user has provided their workout preferences. Your task is to generate a creative workout title and a short, encouraging summary.
                User Preferences:
                - Goal: ${currentSelections.goal}
                - Equipment: ${currentSelections.equipment.join(', ')}
                - Target Muscles: ${currentSelections.muscles.join(', ')}
                - Duration: ${currentSelections.duration} minutes
                - Experience Level: ${currentSelections.experience}
                The generated workout plan includes these exercises: ${exerciseNames}.
                Based on all this information, provide a JSON object with two keys:
                1. "title": A creative, catchy, and motivational title for this workout (e.g., "The 30-Minute Dumbbell Destroyer", "Full Body Bodyweight Blitz").
                2. "summary": A 2-3 sentence motivational summary to get the user excited. Address the user directly (e.g., "Alright, let's get it! This workout is designed to...").`;
            
            const aiResponse = await callGeminiAPI(prompt);
            
            if (aiResponse) {
                try {
                    const parsedResponse = JSON.parse(aiResponse);
                    workoutTitle.textContent = parsedResponse.title || workoutTitle.textContent;
                    aiSummary.querySelector('p').textContent = parsedResponse.summary || "";
                    aiSummary.classList.remove('hidden');
                } catch (e) {
                    console.error("Failed to parse AI response", e);
                }
            }
            
            loadingSpinner.classList.add('hidden');
            workoutScreen.classList.remove('hidden');
        }

        async function suggestFinisher() {
            const btn = document.getElementById('finisherBtn');
            loadingText.textContent = "Thinking of a challenge...";
            loadingSpinner.classList.remove('hidden');
            btn.disabled = true;
            btn.classList.add('opacity-50');

            const prompt = `You are FitPath AI. Suggest one single, high-intensity 'finisher' exercise to add to the end of a workout.
                User Preferences:
                - Goal: ${currentSelections.goal}
                - Equipment: ${currentSelections.equipment.join(', ')}
                - Experience Level: ${currentSelections.experience}
                The main workout targeted these muscles: ${currentSelections.muscles.join(', ')}.
                Provide a JSON object with two keys:
                1. "finisher_name": The name of the finisher exercise.
                2. "finisher_details": The recommended sets/reps or duration (e.g., 'AMRAP for 2 minutes', '3 rounds of 10 reps', '50 reps for time').`;
            
            const aiResponse = await callGeminiAPI(prompt);

            if (aiResponse) {
                try {
                    const parsedResponse = JSON.parse(aiResponse);
                    const finisher = {
                        name: parsedResponse.finisher_name,
                        primary_muscle: '🔥 Finisher',
                        sets: '1',
                        reps: parsedResponse.finisher_details
                    };
                    displayFinisher(finisher);
                } catch (e) {
                     console.error("Failed to parse finisher response", e);
                     displayFinisher({ name: "Burpees", primary_muscle: '🔥 Finisher', sets: '1', reps: 'AMRAP for 60s' });
                }
            } else {
                 displayFinisher({ name: "Burpees", primary_muscle: '🔥 Finisher', sets: '1', reps: 'AMRAP for 60s' });
            }

            loadingSpinner.classList.add('hidden');
            btn.remove();
        }
        
        function displayFinisher(exercise) {
            const exerciseEl = document.createElement('div');
            const icon = iconMap[exercise.primary_muscle] || iconMap['Full Body'];
            exerciseEl.className = `bg-slate-800/80 backdrop-blur-sm p-4 rounded-lg shadow-lg fade-in border border-purple-500 mt-4 stagger-in`;
            exerciseEl.style.animationDelay = `${workoutList.children.length * 100}ms`;
            exerciseEl.innerHTML = `
                <div class="flex items-center space-x-4">
                     <div class="flex-shrink-0">
                        ${icon.replace('w-8 h-8 text-indigo-400', 'w-8 h-8 text-purple-400')}
                     </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-lg font-bold text-white truncate">${exercise.name}</p>
                        <p class="text-sm text-purple-400 font-semibold">${exercise.primary_muscle}</p>
                    </div>
                    <div class="text-right flex-shrink-0">
                        <p class="text-lg font-bold text-white">${exercise.sets} x ${exercise.reps}</p>
                    </div>
                </div>`;
            workoutList.appendChild(exerciseEl);
        }

        function buildWorkout(selections) {
            let filteredExercises = filterExercises(selections);
            let workoutPlan = [];
            
            const { duration, goal, intensity } = selections;
            
            let numExercises;
            if (duration <= 15) numExercises = 3;
            else if (duration <= 30) numExercises = 5;
            else if (duration <= 60) numExercises = 7;
            else numExercises = 9;

            workoutPlan.push({ name: "Jumping Jacks", primary_muscle: "Warm-up", sets: "1", reps: "60s" });
            workoutPlan.push({ name: "Arm Circles", primary_muscle: "Warm-up", sets: "1", reps: "30s each way" });
            
            filteredExercises = shuffleArray(filteredExercises);
            
            for (let i = 0; i < numExercises && i < filteredExercises.length; i++) {
                const exercise = filteredExercises[i];
                const scheme = getSetRepScheme(goal, intensity);
                workoutPlan.push({ ...exercise, ...scheme });
            }
            
            workoutPlan.push({ name: "Quad Stretch", primary_muscle: "Cool-down", sets: "1", reps: "30s each side" });
            workoutPlan.push({ name: "Hamstring Stretch", primary_muscle: "Cool-down", sets: "1", reps: "30s each side" });

            return workoutPlan;
        }

        function filterExercises(selections) {
            const { equipment, muscles, experience } = selections;
            
            let targetMuscles = [];
            if (muscles.includes("Full Body")) {
                targetMuscles = muscleGroups["Full Body"];
            } else {
                muscles.forEach(group => {
                    targetMuscles.push(...(muscleGroups[group] || [group]));
                });
            }
            const uniqueTargetMuscles = new Set(targetMuscles);

            return exerciseDB.filter(ex => {
                const hasEquipment = equipment.some(eq => ex.equipment.includes(eq));
                const hasMuscle = uniqueTargetMuscles.has(ex.primary_muscle);
                const hasDifficulty = experience === 'Advanced' ? true : (experience === 'Intermediate' ? ['Beginner', 'Intermediate'].includes(ex.difficulty) : ex.difficulty === 'Beginner');

                return hasEquipment && hasMuscle && hasDifficulty;
            });
        }
        
        function getSetRepScheme(goal, intensity) {
            let scheme = { sets: 3, reps: '10-12', rest: 60 };

            switch (goal) {
                case 'Build Muscle': scheme = { sets: 3, reps: '8-12', rest: 60 }; break;
                case 'Get Stronger': scheme = { sets: 4, reps: '3-5', rest: 90 }; break;
                case 'Lose Weight':
                case 'Improve Endurance':
                    scheme = { sets: 3, reps: '15-20', rest: 30 };
                    if (intensity === 'High') {
                        scheme = { sets: '3 Rounds', reps: '40s work / 20s rest', rest: 20 };
                    }
                    break;
                case 'Increase Flexibility': scheme = { sets: 2, reps: '30-60s hold', rest: 15 }; break;
                case 'General Fitness': default: scheme = { sets: 3, reps: '10-15', rest: 45 }; break;
            }
            restTime = scheme.rest;
            return scheme;
        }

        function displayWorkout(workout, selections, useAiContent = true) {
            workoutList.innerHTML = '';
            
            const { goal, equipment, duration } = selections;
            let durationText = "";
            if(duration <= 15) durationText = "<15 Min";
            else if(duration <= 30) durationText = "15-30 Min";
            else if(duration <= 60) durationText = "30-60 Min";
            else durationText = "60+ Min";
            
            if (!useAiContent) {
                workoutTitle.textContent = `${durationText} ${goal} Workout`;
            }
            workoutSubtitle.textContent = `Using: ${equipment.join(', ')}`;
            
            workout.forEach((exercise, index) => {
                const isWarmupOrCooldown = exercise.primary_muscle === "Warm-up" || exercise.primary_muscle === "Cool-down";
                const bgColor = 'bg-slate-800/60 backdrop-blur-sm';
                const icon = iconMap[exercise.primary_muscle] || iconMap['Full Body'];
                
                let muscleText = exercise.primary_muscle;
                let textColor = 'text-indigo-400';
                if (exercise.primary_muscle === 'Warm-up') {
                    muscleText = '☀️ Warm-up';
                    textColor = 'text-yellow-400';
                } else if (exercise.primary_muscle === 'Cool-down') {
                    muscleText = '❄️ Cool-down';
                    textColor = 'text-emerald-400';
                }

                const exerciseEl = document.createElement('div');
                exerciseEl.className = `${bgColor} p-4 rounded-lg shadow-lg border border-slate-700 stagger-in`;
                exerciseEl.style.animationDelay = `${index * 100}ms`;

                exerciseEl.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <div class="flex-shrink-0">${icon}</div>
                        <div class="flex-1 min-w-0">
                            <p class="text-lg font-bold text-white truncate">${exercise.name}</p>
                            <p class="text-sm ${textColor} font-semibold">${muscleText}</p>
                        </div>
                        <div class="text-right flex-shrink-0">
                            <p class="text-lg font-bold text-white">${exercise.sets} x ${exercise.reps}</p>
                            ${!isWarmupOrCooldown ? `<p class="text-sm text-slate-400">Rest: ${exercise.rest}s</p>` : ''}
                        </div>
                    </div>
                    ${!isWarmupOrCooldown ? `
                    <div class="mt-3 text-right">
                         <button data-index="${index}" class="swap-btn bg-slate-600 hover:bg-slate-500 text-white text-xs py-1 px-3 rounded-full transition duration-200">Swap</button>
                    </div>` : ''}
                `;
                workoutList.appendChild(exerciseEl);
            });
            
            document.querySelectorAll('.swap-btn').forEach(btn => {
                btn.addEventListener('click', (e) => swapExercise(e.target.dataset.index, workout, selections));
            });
        }
        
        function swapExercise(indexToSwap, currentWorkout, selections) {
            const exerciseToSwap = currentWorkout[indexToSwap];
            let potentialReplacements = filterExercises(selections).filter(ex => {
                if (ex.primary_muscle !== exerciseToSwap.primary_muscle) return false;
                return !currentWorkout.some(wEx => wEx.name === ex.name);
            });
            
            if (potentialReplacements.length > 0) {
                const newExercise = potentialReplacements[0];
                const scheme = getSetRepScheme(selections.goal, selections.intensity);
                currentWorkout[indexToSwap] = { ...newExercise, ...scheme };
                displayWorkout(currentWorkout, selections); 
            } else {
                console.log("No suitable replacement found.");
            }
        }
        
        function showSelectionScreen() {
            workoutScreen.classList.add('hidden');
            selectionScreen.classList.remove('hidden');
            stopTimer();
            workoutTimer.classList.add('hidden');
            startBtn.innerHTML = `▶️ Start Workout <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
        }

        function startWorkout() {
            workoutTimer.classList.remove('hidden');
            startBtn.innerHTML = `⏭️ Next Set <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path></svg>`;
            startTimer(restTime);
        }

        function startTimer(duration) {
            stopTimer();
            let timer = duration;
            updateTimerDisplay(timer);

            timerInterval = setInterval(() => {
                timer--;
                updateTimerDisplay(timer);
                if (timer <= 0) {
                    stopTimer();
                }
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }

        function updateTimerDisplay(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
    });
    </script>
</body>
</html>



